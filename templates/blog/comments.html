{% comment %}
raptiye
Copyright (C)  Alper KANAT  <alperkanat@raptiye.org>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}

{% load comment_filters %}

<a name="comments"></a>

<div id="comment_layer">
	{% for comment in entry.published_comments %}
	<div class="entry_comments_container">
		<div class="comment_ok"></div>
		<table class="entry_comment" cellpadding="0" cellspacing="0" border="0">
			<tr>
				<td class="entry_comment_info_box">
					<div class="entry_comment_avatar">
						<img src="{{ comment.author.get_profile.avatar }}" title="{% if user.is_authenticated %}{{ comment.author.username }}{% else %}{{ comment.anonymous_author }}{% endif %} kullanıcısının avatarı" width="50" height="50">
					</div>
					<div class="entry_comment_info">
						{% ifnotequal comment.author.get_profile.web_site "" %}
							<a href="{{ comment.author.get_profile.web_site }}" title="{{ comment.author.username }} adlı kullanıcıya ait web sayfasını görüntülemek için tıklayın.." target="_blank">
						{% endifnotequal %}
						{% ifnotequal comment.anonymous_author_web_site "" %}
							<a href="{{ comment.anonymous_author_web_site }}" title="{{ comment.anonymous_author }} adlı kullanıcıya ait web sayfasını görüntülemek için tıklayın.." target="_blank">
						{% endifnotequal %}
						{% ifequal comment.author.username "anonymous" %}
								{{ comment.anonymous_author }}
						{% else %}
								{{ comment.author.username }}
						{% endifequal %}
						{% ifnotequal comment.author.get_profile.web_site "" %}
							</a>
						{% endifnotequal %}
						{% ifnotequal comment.anonymous_author_web_site "" %}
							</a>
						{% endifnotequal %}
						<div class="entry_comment_datetime">{{ comment.datetime|date:"d.m.Y, H:i" }}</div>
					</div>
				</td>
				<td class="entry_comment_content_box">
					<p align="justify">
						{{ comment.content|linebreaksbr }}
					</p>
				</td>
			</tr>
		</table>
	</div>
	{% endfor %}
</div>

{% include "blog/comments_upper_ad.html" %}

{% if entry.comments_enabled %}
<input id="disableForm" type="hidden" value="0" />

{% if allow_anonymous_comments or user.is_authenticated %}
<div id="entry_comment_write" {% if allow_anonymous_comments %}style="height: 220px;"{% endif %}>
	{% if allow_anonymous_comments %}
	<table id="entry_comment_anonymous_author">
		<tr>
			<td style="text-align: right;">
				{{ form.anonymous_full_name.label_tag }}:
			</td>
			<td width="15"></td>
			<td>
				{{ form.anonymous_full_name }}
			</td>
		</tr>
		<tr>
			<td style="text-align: right;">
				{{ form.anonymous_email.label_tag }}:
			</td>
			<td width="15"></td>
			<td>
				{{ form.anonymous_email }}
			</td>
		</tr>
		<tr>
			<td style="text-align: right;">
				{{ form.anonymous_website.label_tag }}:
			</td>
			<td width="15"></td>
			<td>
				{{ form.anonymous_website }}
			</td>
		</tr>
	</table>
	<div id="entry_comment_anonymous_warning">
		Giriş yapmamış kullanıcıların,
		<br>
		&nbsp;&nbsp;&nbsp;<strong>&raquo;</strong> tüm yorumları moderasyondan geçer.
		<div style="margin-top: 10px; text-align: center">
			<a href="{% url login_page %}" class="ulink">giriş yap</a> | 
			<a href="{% url registration %}" class="ulink">kaydol</a>
		</div>
	</div>
	{% endif %}
	<div id="entry_comment_write_left">
		<textarea id="entry_comment_textarea" name="comment_body"></textarea>
		{% if entry|check_if_user_subscribed:user %}
		<br>
		<div id="entry_comment_notification">
			{{ form.notification }} {{ form.notification.label_tag }}
		</div>
		{% endif %}
	</div>
	<div id="entry_comment_write_right">
		<div id="entry_comment_write_captcha">
			<div id="captcha_box">
				<img id="captcha_image" src="{{ captcha }}" title="captcha">
				<br>
				<a href="#" title="yeni bir captcha için tıklayın.." class="gray_link" onclick="getNewCaptcha(); return false;">[yenile]</a>
				{{ form.captcha }}
			</div>
		</div>
		<div id="sending_comment" style="display: none;">
			<img src="/media/images/loader.gif" align="absmiddle"> Yollanıyor...
		</div>
		<div id="entry_comment_buttons">
			<button id="submit_button">yolla</button>
			<button id="clear_button">temizle</button>
		</div>
		<div id="comment_error" style="display: none;"></div>
	</div>
</div>
{% else %}
<div id="entry_comment_write">
	<div id="entry_comment_login">
		Yorum yapabilmek için <a href="{% url registration %}?next={{ request.path }}" class="ulink" 
			title="kayıt olmak için tıklayın..">kayıt</a> olmalısınız. Eğer zaten kayıtlı
		iseniz <a href="{% url login_page %}?next={{ request.path }}" class="ulink"
			title="raptiye'ye kayıt olmak için tıklayın..">buraya</a> 
		tıklayarak giriş yapabilirsiniz.
	</div>
</div>
{% endif %}

<script language="javascript">
	$("#submit_button").click(function() {
		var entry_id = {{ entry.id }};
		var url = "{% url comment_sent %}";
		var captcha_id = $("#captcha_image").attr('src').split('/')[3].split('.')[0];
		var query = $("#entry_comment_write :input").serialize() + "&captcha_id=" + captcha_id + "&entry_id=" + entry_id;
		toggleForm("#entry_comment_write");
		$("#sending_comment").slideToggle();
		$.post(url, query, function(resp) {
			// show new captcha
			getNewCaptcha();
			// show the newly added comment if submission is successfull..
			if (!resp.status) {
				// inserting the comment to the comment layer..
				insertComment2Layer($('#entry_comment_textarea').val());
				// clearing comment form
				if ($("#id_notification").attr("checked")) {
					clearCommentForm(true);
				} else {
					clearCommentForm();
				}
			}
			$("#sending_comment").slideToggle();
			toggleForm("#entry_comment_write");
			// showing status
			showStatusMessage(resp);
		}, "json");
	});
	$("#clear_button").click(function() {
		clearCommentForm();
		$("#comment_error").slideUp("slow");
	});
	
	function insertComment2Layer (text) {
		var dt = new Date();
		var day = dt.getDate() < 10 ? '0' + dt.getDate() : dt.getDate();
		var month = (dt.getMonth() + 1) < 10 ? '0' + (dt.getMonth() + 1) : (dt.getMonth() + 1);
		var year = dt.getFullYear();
		var hour = dt.getHours() < 10 ? '0' + dt.getHours() : dt.getHours();
		var minutes = dt.getMinutes() < 10 ? '0' + dt.getMinutes() : dt.getMinutes();
		var datetime = day + '.' + month + '.' + year + ', ' + hour + ':' + minutes;
		var WARNING = '{% show_warning %}';
		
		// replacing \n characters with <br>
		text = text.replace(/\n/g, "<br>")
		
		$('<div>').addClass('entry_comments_container').append(
			$('<div>').addClass('comment_ok')
		).append(
			$('<table>').addClass('entry_comment').attr({
				'cellpadding': '0',
				'cellspacing': '0',
				'border': '0'
			}).append(
				$('<tr>').append(
					$('<td>').addClass('entry_comment_info_box').append(
						$('<div>').addClass('entry_comment_avatar').append(
							$('<img>').attr({
								{% if user.is_authenticated %}
								'src': '{{ user.get_profile.avatar|safe }}',
								'title': '{{ user.username }} kullanıcısının avatarı',
								{% else %}
								'src': '/media/images/default_avatar.png',
								'title': $("#id_anonymous_full_name").val() + ' kullanıcısının avatarı',
								{% endif %}
								'width': '50',
								'height': '50'
							})
						)
					).append(
						{% if user.is_authenticated %}
						$('<div>').addClass('entry_comment_info').html('{{ user.username }}').append(
						{% else %}
						$('<div>').addClass('entry_comment_info').html(
							$("#id_anonymous_full_name").val()
						).append(
						{% endif %}
							$('<div>').addClass('entry_comment_datetime').html(datetime)
						)
					)
				).append(
					$('<td>').addClass('entry_comment_content_box').append(
						$('<p>').attr('align', 'justify').html(
							// if the user doesn't have a published comment before
							// his comment will not be published until an admin marks it
							// as published.. so informing the user about this..
							({{ user|has_published_comment }}) ? text : "<span class='warning'>" + WARNING + "</span><br><br>" + text
						)
					)
				)
			)
		).appendTo($('#comment_layer'));
	}
	
	function showStatusMessage(resp) {
		// reset status
		$("#comment_error").slideUp("slow", function() {
			$("#comment_error").text("");
			if (resp.status) {
				if (resp.error.constructor == Array && resp.error.length > 0) {
					// ensure the errors are ordered
					resp.error = resp.error.sort()
					$("#comment_error").text(resp.error[0]);
				} else {
					$("#comment_error").text(resp.error);
				}
				$("#comment_error").css('background-color', 'red');
				$("#comment_error").slideDown('slow');
			} else {
				$("#comment_error").text(resp.success);
				$("#comment_error").css('background-color', 'green');
				$("#comment_error").slideDown('slow');
			}
		});
	}
	
	function clearCommentForm(notification) {
		notification = notification ? true : false
		
		{% if not user.is_authenticated %}
		$("#entry_comment_anonymous_author :input").val("")
		{% endif %}
		
		$("#entry_comment_textarea").val("");
		$("#id_captcha").val("");
		$("#id_notification").removeAttr("checked");
		
		// removing notification box if already assigned
		if (notification) {
			$("#entry_comment_notification").remove()
		}
	}
</script>
{% endif %}
